<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.rp.order.repository.OrderRepositoryImpl">
	<resultMap id="detailOrdersMap" type="com.rp.order.model.Order">
		<id column="ord_no" property="ordNo"/>
		<result column="mbr_id" property="mbrId"/>
		<result column="ord_tot_amt" property="ordTotAmt"/>
		<result column="ord_stat_cd" property="ordStatCd"/>
		<result column="ord_ymdt" property="ordYmdt"/>
		<association property="delivery" column="dlv_ord_no" javaType="com.rp.order.model.Delivery" resultMap="deliveryMap"/>
		<collection property="orderProds" ofType="com.rp.order.model.OrderProd" resultMap="orderProdsMap"/>
	</resultMap>
	
	<resultMap id="orderProdsMap" type="com.rp.order.model.OrderProd">
		<id column="op_ord_no" property="ordNo"/>
		<result column="seq" property="seq"/>
		<result column="prod_no" property="prodNo"/>
		<result column="prod_nm" property="prodNm"/>
		<result column="prod_amt" property="prodAmt"/>
		<result column="ord_prod_cnt" property="ordProdCnt"/>
		<result column="purch_cfrm_dt" property="purchCfrmDt"/>
		<result column="seller_id" property="sellerId"/>
	</resultMap>
	
	<resultMap id="deliveryMap" type="com.rp.order.model.Delivery">
		<id column="dlv_ord_no" property="ordNo"/>
		<result column="addr" property="addr"/>
		<result column="shp_no" property="shpNo"/>
	</resultMap>
	
	<insert id="insertOrder" parameterType="com.rp.order.model.Order">
		INSERT INTO rp_order (
			ord_no,
			mbr_id,
			ord_tot_amt,
			ord_stat_cd,
			ord_ymdt
		) values (
			#{ordNo},
			#{mbrId},
			#{ordTotAmt},
			#{ordStatCd},
			#{ordYmdt}
		)
	</insert>
	
	<update id="updateOrder" parameterType="com.rp.order.model.Order">
		UPDATE rp_order
		<trim prefix="SET" suffixOverrides=",">
			<if test="ordTotAmt != null">ord_tot_amt = #{ordTotAmt},</if>
			<if test="ordStatCd != null">ord_stat_cd = #{ordStatCd},</if>
		</trim> 	
		WHERE ord_no = #{ordNo}
	</update>
	
	<select id="selectOrders" parameterType="com.rp.order.model.OrderParam" resultType="com.rp.order.model.Order">
		SELECT 
			ord_no as ordNo,
			mbr_id as mbrId,
			ord_tot_amt as ordTotAmt,
			ord_stat_cd as ordStatCd,
			ord_ymdt as ordYmdt
		FROM rp_order
		<trim prefix="WHERE" prefixOverrides="AND|OR">
			<if test="mbrId != null">AND mbr_id = #{mbrId}</if>
			<if test="ordStat != null">AND ord_stat_cd = #{ordStat.code}</if>
			<if test="ordNoLike != null">AND ord_no LIKE CONCAT(#{ordNoLike},'%')</if>
		</trim>
		ORDER BY ord_no
	</select>
	
	<select id="selectDetailOrders" parameterType="com.rp.order.model.OrderParam" resultMap="detailOrdersMap">
		SELECT
			o.ord_no,
			o.mbr_id,
			o.ord_tot_amt,
			o.ord_stat_cd,
			o.ord_ymdt,
			op.ord_no as op_ord_no,
			op.seq,
			op.prod_no,
			op.prod_nm,
			op.prod_amt,
			op.ord_prod_cnt,
			op.purch_cfrm_dt,
			op.seller_id,
			dlv.ord_no as dlv_ord_no,
			dlv.addr,
			dlv.shp_no
		FROM rp_order o,
			rp_order_prod op,
			rp_delivery dlv
		WHERE o.ord_no = op.ord_no
		AND o.ord_no = dlv.ord_no
		<if test="mbrId != null">AND o.mbr_id = #{mbrId}</if>
		<if test="ordStat != null">AND o.ord_stat_cd = #{ordStat.code}</if>
		<if test="ordNoLike != null">AND o.ord_no LIKE CONCAT(#{ordNoLike},'%')</if>
	</select>
</mapper>